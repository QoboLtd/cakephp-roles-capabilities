language: php

dist: xenial

php:
  - 7.2
  - 7.3
  - 7.4

sudo: false

services:
  - mysql

cache:
  directories:
    - vendor
    - $HOME/.composer/cache

env:
  matrix:
    - DB=mysql db_dsn='mysql://root@0.0.0.0/cakephp_test'
  global:
    - DEFAULT=1

matrix:
  fast_finish: true

  include:
    - php: 7.2
      env: PHPCS=1 COVERAGE=1 PHPSTAN=1
    - php: 7.3
      env: PHPCS=1 COVERAGE=0 PHPSTAN=1
    - php: 7.4
      env: PHPCS=1 COVERAGE=0 PHPSTAN=1

install:
  - composer validate --strict
  - composer install --prefer-dist --no-interaction
  - mkdir -p build/test-coverage build/test-results

before_script:
  - sh -c "if [ '$DB' = 'mysql' ]; then mysql -e 'CREATE DATABASE IF NOT EXISTS cakephp_test DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;'; fi"

script:
  - if [[ $PHPCS = 1 ]]; then ./vendor/bin/phpcs; fi
  - if [[ $COVERAGE = 0 ]]; then ./vendor/bin/phpunit --no-coverage; fi
  - if [[ $COVERAGE = 1 ]]; then ./vendor/bin/phpunit; fi
  - if [[ $PHPSTAN = 1 ]]; then ./vendor/bin/phpstan analyse; fi

after_success:
  - curl -s https://codecov.io/bash > /tmp/codecov.sh
  - chmod +x /tmp/codecov.sh
  - /tmp/codecov.sh -s build/test-results

notifications:
  email:
    - webdev@qobocloud.com
